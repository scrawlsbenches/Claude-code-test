#!/bin/bash
# Pre-commit hook for HotSwap Distributed Kernel
# This hook enforces the pre-commit checklist from CLAUDE.md
#
# To install: run .githooks/install-hooks.sh
# To bypass: use git commit --no-verify (NOT recommended)

set -e  # Exit on any error

echo "üîç Running pre-commit checks..."
echo ""

# Check if .NET SDK is available
if ! command -v dotnet &> /dev/null; then
    echo "‚ùå .NET SDK not found. Please install .NET 8.0 SDK."
    echo "   See CLAUDE.md 'Development Environment Setup' section."
    exit 1
fi

# Step 1: Clean build artifacts and restore packages
echo "üì¶ Step 1/5: Clean and restore packages..."
dotnet clean > /dev/null 2>&1
if ! dotnet restore > /dev/null 2>&1; then
    echo "‚ùå Package restore failed. Check your internet connection and NuGet sources."
    exit 1
fi

# Step 2: Build solution (non-incremental)
echo "üî® Step 2/5: Building solution (non-incremental)..."
BUILD_OUTPUT=$(dotnet build --no-incremental 2>&1)
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "‚ùå BUILD FAILED - Fix compilation errors before committing:"
    echo "$BUILD_OUTPUT"
    exit 1
fi

# Step 3: Check for warnings (strict: fail on ANY warnings)
WARNING_COUNT=$(echo "$BUILD_OUTPUT" | grep -c "Warning(s)" || true)
if echo "$BUILD_OUTPUT" | grep -q "1 Warning(s)" || echo "$BUILD_OUTPUT" | grep -q "[2-9] Warning(s)"; then
    echo "‚ùå BUILD WARNINGS DETECTED - Fix all warnings before committing:"
    echo "$BUILD_OUTPUT" | grep -A 5 "Warning(s)"
    echo ""
    echo "   Run: dotnet build --no-incremental"
    exit 1
fi

echo "‚úÖ Build succeeded with 0 warnings"

# Step 4: Run all tests
echo "üß™ Step 3/5: Running all tests..."
TEST_OUTPUT=$(dotnet test --verbosity quiet 2>&1)
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "‚ùå TESTS FAILED:"
    echo "$TEST_OUTPUT"
    echo ""
    echo "   Run: dotnet test --verbosity normal"
    exit 1
fi

# Check for actual test failures (not "Failed:     0")
if echo "$TEST_OUTPUT" | grep -E "Failed:\s+[1-9]"; then
    echo "‚ùå TESTS FAILED:"
    echo "$TEST_OUTPUT" | grep "Failed:"
    exit 1
fi

echo "‚úÖ All tests passed"

# Step 5: Verify staged files
echo "üìù Step 4/5: Verifying staged changes..."
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "‚ö†Ô∏è  No files staged for commit"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
echo ""
echo "üìä Test Summary:"
echo "$TEST_OUTPUT" | grep -E "(Passed|Failed|Skipped|Total)" | tail -5
echo ""
echo "üìã Files to be committed:"
echo "$STAGED_FILES"
echo ""

exit 0
