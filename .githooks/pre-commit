#!/bin/bash
# Pre-commit hook for Distributed Kernel Orchestration System
# Based on CLAUDE.md Pre-Commit Checklist
# Auto-generated by Claude Code Task List Worker 2
#
# Installation: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."

# Step 1: Clean Build
echo ""
echo "üì¶ Step 1/4: Clean and restore packages..."
dotnet clean > /dev/null 2>&1
dotnet restore > /dev/null 2>&1

# Step 2: Build (non-incremental)
echo "üî® Step 2/4: Building solution (non-incremental)..."
BUILD_OUTPUT=$(dotnet build --no-incremental 2>&1)
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "‚ùå BUILD FAILED - Fix errors before committing:"
    echo "$BUILD_OUTPUT"
    exit 1
fi

# Check for warnings
WARNING_COUNT=$(echo "$BUILD_OUTPUT" | grep -c "Warning(s)" || true)
if echo "$BUILD_OUTPUT" | grep -q "1 Warning(s)" || echo "$BUILD_OUTPUT" | grep -q "[2-9] Warning(s)"; then
    echo "‚ö†Ô∏è  BUILD WARNINGS DETECTED:"
    echo "$BUILD_OUTPUT" | grep -A 5 "Warning(s)"
    echo ""
    echo "‚ùå Fix all warnings before committing"
    exit 1
fi

echo "‚úÖ Build succeeded with 0 warnings"

# Step 3: Run ALL tests
echo "üß™ Step 3/4: Running all tests..."
TEST_OUTPUT=$(dotnet test --verbosity quiet 2>&1)
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "‚ùå TESTS FAILED:"
    echo "$TEST_OUTPUT"
    exit 1
fi

# Check for test failures
if echo "$TEST_OUTPUT" | grep -q "Failed:"; then
    echo "‚ùå TESTS FAILED:"
    echo "$TEST_OUTPUT" | grep "Failed:"
    exit 1
fi

echo "‚úÖ All tests passed"

# Step 4: Verify staged files
echo "üìù Step 4/4: Verifying staged changes..."
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "‚ö†Ô∏è  No files staged for commit"
    exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
echo ""
echo "üìã Files to be committed:"
echo "$STAGED_FILES"
echo ""
