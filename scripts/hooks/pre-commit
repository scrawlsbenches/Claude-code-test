#!/bin/bash
# Pre-commit hook for Claude-code-test
# Enforces build and test requirements before committing
# Based on CLAUDE.md Pre-Commit Checklist

set -e  # Exit on any error

echo "üîç Running pre-commit checks..."
echo ""

# Step 1: Clean build artifacts
echo "1Ô∏è‚É£  Cleaning build artifacts..."
dotnet clean --verbosity quiet
if [ $? -ne 0 ]; then
    echo "‚ùå dotnet clean failed"
    exit 1
fi
echo "‚úÖ Clean completed"
echo ""

# Step 2: Restore NuGet packages
echo "2Ô∏è‚É£  Restoring NuGet packages..."
dotnet restore --verbosity quiet
if [ $? -ne 0 ]; then
    echo "‚ùå dotnet restore failed"
    exit 1
fi
echo "‚úÖ Restore completed"
echo ""

# Step 3: Build solution (non-incremental)
echo "3Ô∏è‚É£  Building solution (non-incremental)..."
dotnet build --no-incremental --verbosity quiet
if [ $? -ne 0 ]; then
    echo "‚ùå dotnet build failed - Fix build errors before committing"
    exit 1
fi
echo "‚úÖ Build succeeded"
echo ""

# Step 4: Run all tests
echo "4Ô∏è‚É£  Running all tests..."
dotnet test --verbosity quiet --no-build
if [ $? -ne 0 ]; then
    echo "‚ùå Tests failed - Fix failing tests before committing"
    exit 1
fi
echo "‚úÖ All tests passed"
echo ""

echo "‚ú® Pre-commit checks passed! Proceeding with commit..."
exit 0
